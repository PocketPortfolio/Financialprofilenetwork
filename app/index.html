<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pocket Portfolio</title>

  <!-- PWA -->
  <link rel="manifest" href="/app/manifest.webmanifest">
  <link rel="icon" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <meta name="theme-color" content="#0b1220">

  <!-- Styles -->
  <link rel="stylesheet" href="/app/style.css" />

  <!-- (Optional) Tailwind for the app shell only if you really need it here -->
  <!-- <script src="https://cdn.tailwindcss.com"></script> -->
</head>
<body>
  <!-- ===== Nav ===== -->
  <header class="pp-nav">
    <div class="pp-nav-inner">
      <a href="/" class="pp-brand" aria-label="Pocket Portfolio — Home">
        <picture>
          <source srcset="/brand/pp-monogram.svg" type="image/svg+xml" />
          <img src="/icon-192.png" alt="Pocket Portfolio" class="pp-logo" width="32" height="32" fetchpriority="high" />
        </picture>
        <img src="/brand/pp-wordmark.svg" alt="Pocket Portfolio" class="pp-wordmark" width="156" height="20" loading="eager" decoding="async" />
      </a>

      <nav class="pp-links" aria-label="Primary tabs">
        <button class="pp-tab active" data-tab="dashboard" aria-selected="true">Dashboard</button>
        <button class="pp-tab" data-tab="live" aria-selected="false">Live</button>
      </nav>

      <div class="pp-actions">
        <label for="themeSelApp" class="sr-only">Theme</label>
        <select id="themeSelApp" class="btn" title="Theme">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="contrast">High contrast</option>
        </select>

        <div id="auth">
          <button id="sign-in" class="btn primary">Sign in with Google</button>
        </div>

        <div id="profile" class="hidden" aria-live="polite">
          <span id="user-email" class="email"></span>
          <button id="sign-out" class="btn">Sign out</button>
          <button id="delete-account" class="btn danger">Delete account</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="pp-main">
    <section class="metrics">
      <div class="metric-card">Total Invested: <span id="invested">0</span></div>
      <div class="metric-card">Trades: <span id="trade-count">0</span></div>
      <div class="metric-card">Positions: <span id="positions-count">0</span></div>
      <div class="metric-card">P/L (Unrealised): <span id="pl-amount">—</span> <small id="pl-percent" class="muted"></small></div>
    </section>

    <div id="dashboard">
      <section class="card">
        <h2 class="card-title">Add trade</h2>
        <form id="trade-form" autocomplete="off" spellcheck="false">
          <input type="date" id="date" required />
          <input type="text" id="ticker" placeholder="Search stocks or crypto…" list="ticker-suggestions" required />
          <datalist id="ticker-suggestions"></datalist>

          <select id="kind" aria-label="Asset kind">
            <option value="stock">Stock</option>
            <option value="crypto">Crypto</option>
          </select>
          <select id="ccy" aria-label="Trade currency">
            <option>USD</option><option>GBP</option><option>EUR</option>
          </select>

          <input type="number" id="quantity" placeholder="Qty" step="any" inputmode="decimal" required />
          <input type="number" id="price" placeholder="Price" step="any" inputmode="decimal" required />
          <label class="inline"><input type="checkbox" id="mock" /> Mock trade</label>

          <button type="submit" class="btn primary">Add trade</button>

          <div class="csv">
            <strong>Import CSV</strong>
            <input type="file" id="csv-file" accept=".csv" />
          </div>
        </form>
      </section>

      <section class="card">
        <h2 class="card-title">Trades</h2>
        <div class="table-wrap">
          <table id="trades-table" class="data-table">
            <thead><tr><th>Date</th><th>Ticker</th><th>Qty</th><th>Price</th><th>Mock</th><th>Delete</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title">
          Portfolio Breakdown
          <select id="chart-type" style="margin-left:8px;">
            <option value="pie" selected>Pie</option>
            <option value="line">Line</option>
          </select>
        </h2>
        <canvas id="asset-chart" width="400" height="400" aria-label="Portfolio chart"></canvas>
        <p id="chart-note" class="muted" style="margin:.5rem 0 0;"></p>
      </section>

      <section class="card" id="positions" aria-live="polite"></section>

      <section class="card" id="news">
        <h2 class="card-title">News</h2>
        <div id="news-cards" class="news-grid"></div>
      </section>
    </div>

    <section id="live" style="display:none;">
      <section class="card">
        <h2 class="card-title">Live Prices</h2>
        <div class="table-wrap">
          <table id="live-table" class="data-table">
            <colgroup><col style="width:40%"><col style="width:30%"><col style="width:30%"></colgroup>
            <thead><tr><th>Ticker</th><th>Price</th><th>Change</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title" style="display:flex;align-items:center;gap:8px;">Most Traded Today <span class="muted">(US)</span></h2>
        <div class="table-wrap">
          <table id="most-traded-table" class="data-table">
            <colgroup><col style="width:6%"><col style="width:24%"><col style="width:20%"><col style="width:18%"><col style="width:16%"><col style="width:16%"></colgroup>
            <thead><tr><th>#</th><th>Ticker</th><th>Price</th><th>Change</th><th>Volume</th><th>Market Cap</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" crossorigin="anonymous"></script>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>

  <!-- Theme controller -->
  <script>
    (function(){
      const KEY = 'pp-theme';
      const meta = document.querySelector('meta[name="theme-color"]');
      const prefersDark = matchMedia('(prefers-color-scheme: dark)');
      const sel = document.getElementById('themeSelApp');
      function sys(){ return prefersDark.matches ? 'dark' : 'light'; }
      function setTheme(mode){
        const t = mode === 'system' ? sys() : mode;
        document.documentElement.setAttribute('data-theme', t);
        if (meta) meta.content = getComputedStyle(document.documentElement)
          .getPropertyValue('--chrome').trim() || (t==='light'?'#ffffff':'#0b1220');
        localStorage.setItem(KEY, mode);
      }
      const saved = localStorage.getItem(KEY) || 'system';
      if (sel) sel.value = saved;
      setTheme(saved);
      sel?.addEventListener('change', e => setTheme(e.target.value));
      prefersDark.addEventListener?.('change', () => {
        if ((localStorage.getItem(KEY)||'system')==='system') setTheme('system');
      });
    })();
  </script>

  <!-- App logic -->
  <script type="module" src="/app/app.js"></script>

  <!-- SW register (prod only) -->
  <script>
    if ('serviceWorker' in navigator && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      navigator.serviceWorker.register('/app/service-worker.js?sw=8').catch(()=>{});
    }
  </script>
</body>
</html>
