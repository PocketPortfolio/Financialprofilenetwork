"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[586],{1586:function(t,e,a){a.d(e,{K:function(){return n}});var r=a(2265),s=a(4330),d=a(5978),o=a(5923);class c{static async addTrade(t,e){try{let a={...e,uid:t,createdAt:d.EK.now(),updatedAt:d.EK.now()};return(await (0,d.ET)((0,d.hJ)(o.db,"trades"),a)).id}catch(t){throw t}}static async getTrades(t){try{let e=(0,d.IO)((0,d.hJ)(o.db,"trades"),(0,d.ar)("uid","==",t));return(await (0,d.PL)(e)).docs.map(t=>({id:t.id,...t.data()})).sort((t,e)=>{var a,r;let s=(null===(a=t.createdAt)||void 0===a?void 0:a.toDate)?t.createdAt.toDate().getTime():0;return((null===(r=e.createdAt)||void 0===r?void 0:r.toDate)?e.createdAt.toDate().getTime():0)-s})}catch(t){throw t}}static async deleteTrade(t,e){try{await (0,d.oe)((0,d.JU)(o.db,"trades",e))}catch(t){throw t}}static async cleanupOrphanedTrades(t){try{let e=(0,d.IO)((0,d.hJ)(o.db,"trades")),a=await (0,d.PL)(e),r=0;for(let e of a.docs){let a=e.data();(!a.uid||a.uid!==t)&&(await (0,d.oe)(e.ref),r++)}return r}catch(t){throw t}}static async updateTrade(t,e,a){try{await (0,d.r7)((0,d.JU)(o.db,"trades",e),{...a,updatedAt:d.EK.now()})}catch(t){throw t}}static async importTrades(t,e){try{let a=[],r=d.EK.now();for(let s of e)a.push({...s,uid:t,createdAt:r,updatedAt:r});return(await Promise.all(a.map(t=>(0,d.ET)((0,d.hJ)(o.db,"trades"),t)))).map(t=>t.id)}catch(t){throw t}}static async migrateTrades(t,e){try{if(!e||0===e.length)return;let a=(0,d.qs)(o.db),r=d.EK.now(),s=0;for(let c of e)try{let e=(0,d.JU)(o.db,"trades",c),n=await (0,d.QT)(e);if(n.exists()){let d=n.data();(!d.uid||d.uid!==t)&&(a.update(e,{uid:t,updatedAt:r}),s++)}}catch(t){}s>0&&await a.commit()}catch(t){throw t}}static async deleteAllTrades(t){try{let e=(0,d.hJ)(o.db,"trades"),a=(0,d.IO)(e,(0,d.ar)("uid","==",t)),r=await (0,d.PL)(a);if(r.empty)return 0;let s=(0,d.qs)(o.db);return r.docs.forEach(t=>{s.delete(t.ref)}),await s.commit(),r.size}catch(t){throw t}}}function n(){let{user:t,isAuthenticated:e}=(0,s.a)(),[a,d]=(0,r.useState)([]),[o,n]=(0,r.useState)(!1),[i,l]=(0,r.useState)(null),u=(0,r.useCallback)(async()=>{n(!0),l(null);try{if(e&&t){let e=await c.getTrades(t.uid);d(e)}else{let t=localStorage.getItem("pocket-portfolio-local-trades");if(t){let e=JSON.parse(t);d(e)}else d([])}}catch(t){l(t instanceof Error?t.message:"Failed to load trades")}finally{n(!1)}},[t,e]);(0,r.useEffect)(()=>{u()},[null==t?void 0:t.uid,e]);let h=(0,r.useCallback)(async a=>{try{if(e&&t){let e=await c.addTrade(t.uid,a),r={...a,id:e,uid:t.uid,createdAt:{seconds:Date.now()/1e3,nanoseconds:0},updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}};return d(t=>[r,...t]),e}{let t={...a,id:"local-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),uid:"local",createdAt:{seconds:Date.now()/1e3,nanoseconds:0},updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}};return d(e=>{let a=[t,...e];return localStorage.setItem("pocket-portfolio-local-trades",JSON.stringify(a)),a}),t.id}}catch(t){throw l(t instanceof Error?t.message:"Failed to add trade"),t}},[t,e]),w=(0,r.useCallback)(async a=>{let r=a.startsWith("local-");try{r?d(t=>{let e=t.filter(t=>t.id!==a);return localStorage.setItem("pocket-portfolio-local-trades",JSON.stringify(e)),e}):e&&t?(await c.deleteTrade(t.uid,a),d(t=>t.filter(t=>t.id!==a))):d(t=>{let e=t.filter(t=>t.id!==a);return localStorage.setItem("pocket-portfolio-local-trades",JSON.stringify(e)),e})}catch(t){throw l(t instanceof Error?t.message:"Failed to delete trade"),t}},[t,e,a]),f=(0,r.useCallback)(async(e,a)=>{if(!t)throw Error("User not authenticated");try{await c.updateTrade(t.uid,e,a),d(t=>t.map(t=>t.id===e?{...t,...a,updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}}:t))}catch(t){throw l(t instanceof Error?t.message:"Failed to update trade"),t}},[t]),p=(0,r.useCallback)(async a=>{try{if(e&&t){let e=await c.importTrades(t.uid,a),r=a.map((a,r)=>({...a,id:e[r],uid:t.uid,createdAt:{seconds:Date.now()/1e3,nanoseconds:0},updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}}));return d(t=>[...r,...t]),e}{let t=a.map((t,e)=>({...t,id:"local-".concat(Date.now(),"-").concat(e,"-").concat(Math.random().toString(36).substr(2,9)),uid:"local",createdAt:{seconds:Date.now()/1e3,nanoseconds:0},updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}}));return d(e=>{let a=[...t,...e];return localStorage.setItem("pocket-portfolio-local-trades",JSON.stringify(a)),a}),t.map(t=>t.id)}}catch(t){throw l(t instanceof Error?t.message:"Failed to import trades"),t}},[t,e]),y=(0,r.useCallback)(async e=>{if(!t)throw Error("User not authenticated");try{await c.migrateTrades(t.uid,e),await u()}catch(t){throw l(t instanceof Error?t.message:"Failed to migrate trades"),t}},[t,u]),{realTrades:m,mockTrades:g,validTrades:T,userTickers:b,positions:A,totalInvested:E,totalTrades:k,totalPositions:D}=(0,r.useMemo)(()=>{let t=a.filter(t=>!t.mock),e=a.filter(t=>t.mock),r=t.filter(t=>!(!/^[A-Z0-9.-]{1,10}$/.test(t.ticker)||isNaN(t.qty)||isNaN(t.price)||t.qty<=0||t.price<=0)),s=Array.from(new Set(r.map(t=>t.ticker))),d=t.reduce((t,e)=>{let{ticker:a,qty:r,price:s,type:d,date:o}=e;if(t[a]||(t[a]={ticker:a,shares:0,avgCost:0,currency:e.currency||"USD",totalTrades:0,lastTradeDate:o,isMock:!1}),"BUY"===d){let e=t[a].shares*t[a].avgCost+r*s;t[a].shares+=r,t[a].avgCost=e/t[a].shares}else t[a].shares-=r;return t[a].totalTrades+=1,t[a].lastTradeDate=o,t},{}),o=Object.values(d).reduce((t,e)=>t+e.avgCost*e.shares,0),c=t.length,n=Object.keys(d).length;return{realTrades:t,mockTrades:e,validTrades:r,userTickers:s,positions:d,totalInvested:o,totalTrades:c,totalPositions:n}},[a]);return(0,r.useEffect)(()=>{a.length},[a.length,E,m.length,g.length,A,e,null==t?void 0:t.uid]),{trades:a,loading:o,error:i,userTickers:b,totalInvested:E,totalTrades:k,totalPositions:D,addTrade:h,deleteTrade:w,updateTrade:f,importTrades:p,migrateTrades:y,deleteAllTrades:(0,r.useCallback)(async()=>{if(!t)throw Error("User not authenticated");try{let e=await c.deleteAllTrades(t.uid);return d([]),e}catch(t){throw l(t instanceof Error?t.message:"Failed to delete all trades"),t}},[t]),cleanupOrphanedTrades:(0,r.useCallback)(async()=>{if(!t)throw Error("User not authenticated");try{let e=await c.cleanupOrphanedTrades(t.uid);return await u(),e}catch(t){throw l(t instanceof Error?t.message:"Failed to cleanup orphaned trades"),t}},[t,u]),refreshTrades:u}}}}]);