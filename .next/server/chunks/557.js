"use strict";exports.id=557,exports.ids=[557],exports.modules={34583:(e,t,r)=>{r.d(t,{Z:()=>o});var a=r(10326),n=r(17577);function o({trades:e,positions:t,onDeleteTrade:r,onViewTrades:o,noCard:s=!1}){let[i,l]=(0,n.useState)("positions"),[c,d]=(0,n.useState)(null),[p,u]=(0,n.useState)("value"),[g,x]=(0,n.useState)("desc"),h=(0,n.useMemo)(()=>c?e.filter(e=>e.ticker===c):e,[e,c]),f=(0,n.useMemo)(()=>[...t].sort((e,t)=>{let r,a;switch(p){case"ticker":return"asc"===g?e.ticker.localeCompare(t.ticker):t.ticker.localeCompare(e.ticker);case"value":r=e.currentValue,a=t.currentValue;break;case"pl":r=e.unrealizedPL,a=t.unrealizedPL;break;case"plPercent":r=e.unrealizedPLPercent,a=t.unrealizedPLPercent;break;default:return 0}return"asc"===g?r-a:a-r}),[t,p,g]),y=e=>{p===e?x("asc"===g?"desc":"asc"):(u(e),x("desc"))},m=e=>p!==e?"↕️":"asc"===g?"↑":"↓",w=(e,t="USD")=>null==e?"N/A":new Intl.NumberFormat("en-US",{style:"currency",currency:"GBp"===t?"GBP":t,minimumFractionDigits:2,maximumFractionDigits:2}).format(e),b=e=>null==e?"N/A":`${e>=0?"+":""}${e.toFixed(2)}%`;return(0,a.jsxs)("div",{className:s?"":"brand-card brand-grid brand-candlestick",style:s?{}:{background:"var(--card)",border:"1px solid var(--card-border)",borderRadius:"12px",padding:"24px",marginBottom:"32px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)"},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px",flexWrap:"wrap",gap:"16px"},children:[(0,a.jsxs)("div",{children:[a.jsx("h2",{style:{fontSize:"24px",fontWeight:"bold",margin:0,background:"linear-gradient(135deg, var(--brand), #8b5cf6)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text"},children:"Portfolio Overview"}),a.jsx("p",{style:{fontSize:"14px",color:"var(--muted)",margin:"4px 0 0 0"},children:"positions"===i?`${t.length} positions • ${e.length} total trades`:c?`${h.length} trades for ${c}`:`${e.length} trades`})]}),(0,a.jsxs)("div",{style:{display:"flex",gap:"12px",alignItems:"center"},children:[(0,a.jsxs)("div",{style:{display:"flex",background:"var(--warm-bg)",borderRadius:"12px",padding:"6px",border:"2px solid var(--border-warm)"},children:[a.jsx("button",{onClick:()=>l("positions"),style:{padding:"12px 20px",background:"positions"===i?"linear-gradient(135deg, var(--accent-warm) 0%, #f59e0b 100%)":"transparent",color:"positions"===i?"white":"var(--text-warm)",border:"none",borderRadius:"8px",fontSize:"15px",fontWeight:"600",cursor:"pointer",transition:"all 0.2s ease",boxShadow:"positions"===i?"0 4px 12px rgba(245, 158, 11, 0.3)":"none"},onMouseEnter:e=>{"positions"!==i&&(e.currentTarget.style.background="rgba(245, 158, 11, 0.1)",e.currentTarget.style.color="var(--accent-warm)")},onMouseLeave:e=>{"positions"!==i&&(e.currentTarget.style.background="transparent",e.currentTarget.style.color="var(--text-warm)")},children:"\uD83D\uDCCA Positions"}),a.jsx("button",{onClick:()=>l("trades"),style:{padding:"12px 20px",background:"trades"===i?"linear-gradient(135deg, var(--accent-warm) 0%, #f59e0b 100%)":"transparent",color:"trades"===i?"white":"var(--text-warm)",border:"none",borderRadius:"8px",fontSize:"15px",fontWeight:"600",cursor:"pointer",transition:"all 0.2s ease",boxShadow:"trades"===i?"0 4px 12px rgba(245, 158, 11, 0.3)":"none"},onMouseEnter:e=>{"trades"!==i&&(e.currentTarget.style.background="rgba(245, 158, 11, 0.1)",e.currentTarget.style.color="var(--accent-warm)")},onMouseLeave:e=>{"trades"!==i&&(e.currentTarget.style.background="transparent",e.currentTarget.style.color="var(--text-warm)")},children:"\uD83D\uDCC8 Trades"})]}),"trades"===i&&c&&a.jsx("button",{onClick:()=>{d(null),l("positions")},style:{padding:"8px 16px",background:"var(--bg)",color:"var(--text)",border:"1px solid var(--card-border)",borderRadius:"6px",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease"},children:"← Back to Positions"})]})]}),"positions"===i?a.jsx("div",{style:{overflowX:"auto"},children:(0,a.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse"},children:[a.jsx("thead",{style:{background:"var(--bg)"},children:(0,a.jsxs)("tr",{children:[(0,a.jsxs)("th",{style:{padding:"16px",textAlign:"left",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em",cursor:"pointer",userSelect:"none"},onClick:()=>y("ticker"),children:["\uD83D\uDCCA Asset ",m("ticker")]}),(0,a.jsxs)("th",{style:{padding:"16px",textAlign:"right",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em",cursor:"pointer",userSelect:"none"},onClick:()=>y("value"),children:["\uD83D\uDCB0 Value ",m("value")]}),(0,a.jsxs)("th",{style:{padding:"16px",textAlign:"right",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em",cursor:"pointer",userSelect:"none"},onClick:()=>y("pl"),children:["\uD83D\uDCC8 P/L ",m("pl")]}),(0,a.jsxs)("th",{style:{padding:"16px",textAlign:"right",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em",cursor:"pointer",userSelect:"none"},onClick:()=>y("plPercent"),children:["\uD83D\uDCCA P/L % ",m("plPercent")]}),a.jsx("th",{style:{padding:"16px",textAlign:"center",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"⚙️ Actions"})]})}),a.jsx("tbody",{children:f.map(e=>(0,a.jsxs)("tr",{style:{borderBottom:"1px solid var(--card-border)",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.currentTarget.style.background="var(--bg)",onMouseLeave:e=>e.currentTarget.style.background="transparent",children:[(0,a.jsxs)("td",{style:{padding:"16px",whiteSpace:"nowrap"},children:[(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[a.jsx("span",{style:{fontSize:"16px",fontWeight:"600",color:"var(--text)"},children:e.ticker}),e.isMock&&a.jsx("span",{style:{fontSize:"10px",color:"var(--brand)",background:"rgba(139, 92, 246, 0.1)",padding:"2px 6px",borderRadius:"4px",fontWeight:"500"},children:"MOCK"})]}),(0,a.jsxs)("div",{style:{fontSize:"12px",color:"var(--muted)",marginTop:"2px"},children:[e.shares," shares • Avg ","GBP"===e.currency?"\xa3":"GBp"===e.currency?"\xa3":"$",e.avgCost?.toFixed(2)||"N/A"," • ",e.totalTrades||0," trades"]})]}),(0,a.jsxs)("td",{style:{padding:"16px",textAlign:"right",whiteSpace:"nowrap"},children:[a.jsx("div",{style:{fontSize:"16px",fontWeight:"600",color:"var(--text)"},children:w(e.currentValue,e.currency)}),(0,a.jsxs)("div",{style:{fontSize:"12px",color:"var(--muted)"},children:["@ ","GBP"===e.currency?"\xa3":"GBp"===e.currency?"\xa3":"$",e.currentPrice?.toFixed(2)||"N/A"]})]}),a.jsx("td",{style:{padding:"16px",textAlign:"right",whiteSpace:"nowrap"},children:(0,a.jsxs)("div",{style:{fontSize:"16px",fontWeight:"600",color:e.unrealizedPL>=0?"var(--pos)":"var(--neg)"},children:[e.unrealizedPL>=0?"+":"",w(e.unrealizedPL,e.currency)]})}),a.jsx("td",{style:{padding:"16px",textAlign:"right",whiteSpace:"nowrap"},children:a.jsx("div",{style:{fontSize:"16px",fontWeight:"600",color:e.unrealizedPL>=0?"var(--pos)":"var(--neg)"},children:b(e.unrealizedPLPercent)})}),a.jsx("td",{style:{padding:"16px",textAlign:"center"},children:a.jsx("button",{onClick:()=>{d(e.ticker),l("trades")},style:{padding:"8px 16px",background:"linear-gradient(135deg, var(--accent-warm) 0%, #f59e0b 100%)",color:"white",border:"2px solid var(--border-warm)",borderRadius:"8px",fontSize:"13px",fontWeight:"600",cursor:"pointer",transition:"all 0.2s ease",boxShadow:"0 2px 8px rgba(245, 158, 11, 0.3)"},onMouseEnter:e=>{e.currentTarget.style.background="linear-gradient(135deg, #f59e0b 0%, var(--accent-warm) 100%)",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 4px 12px rgba(245, 158, 11, 0.4)"},onMouseLeave:e=>{e.currentTarget.style.background="linear-gradient(135deg, var(--accent-warm) 0%, #f59e0b 100%)",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 8px rgba(245, 158, 11, 0.3)"},children:"\uD83D\uDCC8 View Trades"})})]},e.ticker))})]})}):a.jsx("div",{style:{overflowX:"auto"},children:(0,a.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse"},children:[a.jsx("thead",{style:{background:"var(--bg)"},children:(0,a.jsxs)("tr",{children:[a.jsx("th",{style:{padding:"16px",textAlign:"left",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"\uD83D\uDCC5 Date"}),a.jsx("th",{style:{padding:"16px",textAlign:"left",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"\uD83D\uDCCA Ticker"}),a.jsx("th",{style:{padding:"16px",textAlign:"left",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"\uD83D\uDD04 Type"}),a.jsx("th",{style:{padding:"16px",textAlign:"right",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"\uD83D\uDCE6 Qty"}),a.jsx("th",{style:{padding:"16px",textAlign:"right",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"\uD83D\uDCB0 Price"}),a.jsx("th",{style:{padding:"16px",textAlign:"right",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"\uD83D\uDCB5 Value"}),a.jsx("th",{style:{padding:"16px",textAlign:"center",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"✅ Status"}),a.jsx("th",{style:{padding:"16px",textAlign:"center",fontSize:"13px",fontWeight:"700",color:"var(--text-warm)",textTransform:"uppercase",letterSpacing:"0.05em"},children:"⚙️ Actions"})]})}),a.jsx("tbody",{children:h.map(e=>(0,a.jsxs)("tr",{style:{borderBottom:"1px solid var(--card-border)",opacity:e.mock?.7:1,background:e.mock?"var(--bg)":"transparent",transition:"background-color 0.2s ease"},onMouseEnter:t=>t.currentTarget.style.background=e.mock?"var(--card-border)":"var(--bg)",onMouseLeave:t=>t.currentTarget.style.background=e.mock?"var(--bg)":"transparent",children:[a.jsx("td",{style:{padding:"16px",whiteSpace:"nowrap",fontSize:"14px",color:"var(--text)"},children:e.date}),a.jsx("td",{style:{padding:"16px",whiteSpace:"nowrap",fontSize:"14px",fontWeight:"500",color:"var(--text)"},children:e.ticker}),a.jsx("td",{style:{padding:"16px",whiteSpace:"nowrap",fontSize:"14px",color:"var(--text)"},children:a.jsx("span",{style:{padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",background:"BUY"===e.type?"rgba(34, 197, 94, 0.1)":"rgba(239, 68, 68, 0.1)",color:"BUY"===e.type?"var(--pos)":"var(--neg)"},children:e.type})}),a.jsx("td",{style:{padding:"16px",textAlign:"right",whiteSpace:"nowrap",fontSize:"14px",color:"var(--text)"},children:e.qty}),a.jsx("td",{style:{padding:"16px",textAlign:"right",whiteSpace:"nowrap",fontSize:"14px",color:"var(--text)"},children:w(e.price)}),a.jsx("td",{style:{padding:"16px",textAlign:"right",whiteSpace:"nowrap",fontSize:"14px",fontWeight:"500",color:"var(--text)"},children:w(e.qty*e.price)}),a.jsx("td",{style:{padding:"16px",textAlign:"center",whiteSpace:"nowrap"},children:a.jsx("span",{style:{padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",background:e.mock?"rgba(139, 92, 246, 0.1)":"rgba(34, 197, 94, 0.1)",color:e.mock?"var(--brand)":"var(--pos)"},children:e.mock?"Mock":"Real"})}),a.jsx("td",{style:{padding:"16px",textAlign:"center"},children:a.jsx("button",{onClick:()=>r(e.id),style:{padding:"8px 16px",background:"linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",color:"white",border:"2px solid #dc2626",borderRadius:"8px",fontSize:"13px",fontWeight:"600",cursor:"pointer",transition:"all 0.2s ease",boxShadow:"0 2px 8px rgba(220, 38, 38, 0.3)"},onMouseEnter:e=>{e.currentTarget.style.background="linear-gradient(135deg, #dc2626 0%, #ef4444 100%)",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 4px 12px rgba(220, 38, 38, 0.4)"},onMouseLeave:e=>{e.currentTarget.style.background="linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 8px rgba(220, 38, 38, 0.3)"},children:"\uD83D\uDDD1️ Delete"})})]},e.id))})]})}),("positions"===i&&0===t.length||"trades"===i&&0===h.length)&&(0,a.jsxs)("div",{style:{textAlign:"center",padding:"48px 24px",color:"var(--muted)"},children:[a.jsx("div",{style:{fontSize:"48px",marginBottom:"16px"},children:(0,a.jsxs)("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[a.jsx("rect",{x:"3",y:"3",width:"7",height:"7",rx:"1",stroke:"var(--muted)",strokeWidth:"2"}),a.jsx("rect",{x:"14",y:"3",width:"7",height:"7",rx:"1",stroke:"var(--muted)",strokeWidth:"2"}),a.jsx("rect",{x:"14",y:"14",width:"7",height:"7",rx:"1",stroke:"var(--muted)",strokeWidth:"2"}),a.jsx("rect",{x:"3",y:"14",width:"7",height:"7",rx:"1",stroke:"var(--muted)",strokeWidth:"2"})]})}),a.jsx("h3",{style:{fontSize:"18px",fontWeight:"600",margin:"0 0 8px 0",color:"var(--text)"},children:"positions"===i?"No positions yet":"No trades found"}),a.jsx("p",{style:{fontSize:"14px",margin:0},children:"positions"===i?"Add your first trade to see your portfolio positions":c?`No trades found for ${c}`:"No trades available"})]})]})}},87433:(e,t,r)=>{r.d(t,{$C:()=>s,Kg:()=>o,vR:()=>n});var a=r(17577);function n(e,t=12e4){let[r,n]=(0,a.useState)(null),[o,s]=(0,a.useState)(!1),[i,l]=(0,a.useState)(null);(0,a.useRef)(null);let c=(0,a.useRef)(!0),d=(0,a.useRef)(0),p=(0,a.useMemo)(()=>e?.join(",")||"",[e]);return{data:r,loading:o,error:i,refetch:(0,a.useCallback)(async()=>{if(!c.current)return;if(!e||0===e.length){n({}),s(!1),l(null);return}let t=Date.now(),r=`quotes_${p}`,a=localStorage.getItem(r);if(a&&t-d.current<6e5)try{let e=JSON.parse(a);if(c.current){n(e);return}}catch(e){}s(!0),l(null);try{let a=e.join(","),o=await fetch(`/api/quote?symbols=${a}`);if(!o.ok)throw Error(`HTTP error! status: ${o.status}`);let s=await o.json();if(c.current){let e={};s.forEach(t=>{e[t.symbol]=t}),n(e),localStorage.setItem(r,JSON.stringify(e)),d.current=t}}catch(e){c.current&&l(e instanceof Error?e.message:"Failed to fetch quotes")}finally{c.current&&s(!1)}},[p])}}function o(e=[],t=5){let[r,n]=(0,a.useState)(null),[o,s]=(0,a.useState)(!1),[i,l]=(0,a.useState)(null);(0,a.useRef)(null);let c=(0,a.useRef)(!0),d=(0,a.useRef)(0),p=(0,a.useMemo)(()=>e.join(","),[e]);return{data:r,loading:o,error:i,refetch:(0,a.useCallback)(async()=>{if(!c.current)return;let r=Date.now(),a=`news_${p}_${t}`,o=localStorage.getItem(a);if(o&&r-d.current<9e5)try{let e=JSON.parse(o);if(c.current){n(e);return}}catch(e){}s(!0),l(null);try{let o=new URLSearchParams;e.length>0&&o.append("tickers",p),o.append("limit",t.toString());let s=await fetch(`/api/news?${o}`);if(!s.ok)throw Error(`HTTP error! status: ${s.status}`);let i=await s.json();c.current&&(n(i),localStorage.setItem(a,JSON.stringify(i)),d.current=r)}catch(e){c.current&&l(e instanceof Error?e.message:"Failed to fetch news")}finally{c.current&&s(!1)}},[p,t])}}function s(){let[e,t]=(0,a.useState)(null),[r,n]=(0,a.useState)(!1),[o,s]=(0,a.useState)(null);(0,a.useRef)(null);let i=(0,a.useRef)(!0),l=(0,a.useRef)(0);return{data:e,loading:r,error:o,refetch:(0,a.useCallback)(async()=>{if(!i.current)return;let e=Date.now(),r="market_data_most_traded",a=localStorage.getItem(r);if(a&&e-l.current<9e5)try{let e=JSON.parse(a);if(i.current){t(e);return}}catch(e){}n(!0),s(null);try{let a=await fetch("/api/most-traded?count=10&region=US");if(!a.ok)throw Error(`HTTP error! status: ${a.status}`);let n=await a.json();i.current&&(t(n),localStorage.setItem(r,JSON.stringify(n)),l.current=e)}catch(e){i.current&&s(e instanceof Error?e.message:"Failed to fetch market data")}finally{i.current&&n(!1)}},[])}}},90262:(e,t,r)=>{r.d(t,{K:()=>l});var a=r(17577),n=r(27153),o=r(76),s=r(15517);class i{static async addTrade(e,t){try{let r={...t,uid:e,createdAt:o.EK.now(),updatedAt:o.EK.now()};return(await (0,o.ET)((0,o.hJ)(s.db,"trades"),r)).id}catch(e){throw e}}static async getTrades(e){try{let t=(0,o.IO)((0,o.hJ)(s.db,"trades"),(0,o.ar)("uid","==",e));return(await (0,o.PL)(t)).docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>{let r=e.createdAt?.toDate?e.createdAt.toDate().getTime():0;return(t.createdAt?.toDate?t.createdAt.toDate().getTime():0)-r})}catch(e){throw e}}static async deleteTrade(e,t){try{await (0,o.oe)((0,o.JU)(s.db,"trades",t))}catch(e){throw e}}static async cleanupOrphanedTrades(e){try{let t=(0,o.IO)((0,o.hJ)(s.db,"trades")),r=await (0,o.PL)(t),a=0;for(let t of r.docs){let r=t.data();(!r.uid||r.uid!==e)&&(await (0,o.oe)(t.ref),a++)}return a}catch(e){throw e}}static async updateTrade(e,t,r){try{await (0,o.r7)((0,o.JU)(s.db,"trades",t),{...r,updatedAt:o.EK.now()})}catch(e){throw e}}static async importTrades(e,t){try{let r=[],a=o.EK.now();for(let n of t)r.push({...n,uid:e,createdAt:a,updatedAt:a});return(await Promise.all(r.map(e=>(0,o.ET)((0,o.hJ)(s.db,"trades"),e)))).map(e=>e.id)}catch(e){throw e}}static async migrateTrades(e,t){try{if(!t||0===t.length)return;let r=(0,o.qs)(s.db),a=o.EK.now(),n=0;for(let i of t)try{let t=(0,o.JU)(s.db,"trades",i),l=await (0,o.QT)(t);if(l.exists()){let o=l.data();(!o.uid||o.uid!==e)&&(r.update(t,{uid:e,updatedAt:a}),n++)}}catch(e){}n>0&&await r.commit()}catch(e){throw e}}static async deleteAllTrades(e){try{let t=(0,o.hJ)(s.db,"trades"),r=(0,o.IO)(t,(0,o.ar)("uid","==",e)),a=await (0,o.PL)(r);if(a.empty)return 0;let n=(0,o.qs)(s.db);return a.docs.forEach(e=>{n.delete(e.ref)}),await n.commit(),a.size}catch(e){throw e}}}function l(){let{user:e,isAuthenticated:t}=(0,n.a)(),[r,o]=(0,a.useState)([]),[s,l]=(0,a.useState)(!1),[c,d]=(0,a.useState)(null),p=(0,a.useCallback)(async()=>{l(!0),d(null);try{if(t&&e){let t=await i.getTrades(e.uid);o(t)}else{let e=localStorage.getItem("pocket-portfolio-local-trades");if(e){let t=JSON.parse(e);o(t)}else o([])}}catch(e){d(e instanceof Error?e.message:"Failed to load trades")}finally{l(!1)}},[e,t]),u=(0,a.useCallback)(async r=>{try{if(t&&e){let t=await i.addTrade(e.uid,r),a={...r,id:t,uid:e.uid,createdAt:{seconds:Date.now()/1e3,nanoseconds:0},updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}};return o(e=>[a,...e]),t}{let e={...r,id:`local-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,uid:"local",createdAt:{seconds:Date.now()/1e3,nanoseconds:0},updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}};return o(t=>{let r=[e,...t];return localStorage.setItem("pocket-portfolio-local-trades",JSON.stringify(r)),r}),e.id}}catch(e){throw d(e instanceof Error?e.message:"Failed to add trade"),e}},[e,t]),g=(0,a.useCallback)(async r=>{let a=r.startsWith("local-");try{a?o(e=>{let t=e.filter(e=>e.id!==r);return localStorage.setItem("pocket-portfolio-local-trades",JSON.stringify(t)),t}):t&&e?(await i.deleteTrade(e.uid,r),o(e=>e.filter(e=>e.id!==r))):o(e=>{let t=e.filter(e=>e.id!==r);return localStorage.setItem("pocket-portfolio-local-trades",JSON.stringify(t)),t})}catch(e){throw d(e instanceof Error?e.message:"Failed to delete trade"),e}},[e,t,r]),x=(0,a.useCallback)(async(t,r)=>{if(!e)throw Error("User not authenticated");try{await i.updateTrade(e.uid,t,r),o(e=>e.map(e=>e.id===t?{...e,...r,updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}}:e))}catch(e){throw d(e instanceof Error?e.message:"Failed to update trade"),e}},[e]),h=(0,a.useCallback)(async r=>{try{if(t&&e){let t=await i.importTrades(e.uid,r),a=r.map((r,a)=>({...r,id:t[a],uid:e.uid,createdAt:{seconds:Date.now()/1e3,nanoseconds:0},updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}}));return o(e=>[...a,...e]),t}{let e=r.map((e,t)=>({...e,id:`local-${Date.now()}-${t}-${Math.random().toString(36).substr(2,9)}`,uid:"local",createdAt:{seconds:Date.now()/1e3,nanoseconds:0},updatedAt:{seconds:Date.now()/1e3,nanoseconds:0}}));return o(t=>{let r=[...e,...t];return localStorage.setItem("pocket-portfolio-local-trades",JSON.stringify(r)),r}),e.map(e=>e.id)}}catch(e){throw d(e instanceof Error?e.message:"Failed to import trades"),e}},[e,t]),f=(0,a.useCallback)(async t=>{if(!e)throw Error("User not authenticated");try{await i.migrateTrades(e.uid,t),await p()}catch(e){throw d(e instanceof Error?e.message:"Failed to migrate trades"),e}},[e,p]),{realTrades:y,mockTrades:m,validTrades:w,userTickers:b,positions:S,totalInvested:v,totalTrades:k,totalPositions:j}=(0,a.useMemo)(()=>{let e=r.filter(e=>!e.mock),t=r.filter(e=>e.mock),a=e.filter(e=>!(!/^[A-Z0-9.-]{1,10}$/.test(e.ticker)||isNaN(e.qty)||isNaN(e.price)||e.qty<=0||e.price<=0)),n=Array.from(new Set(a.map(e=>e.ticker))),o=e.reduce((e,t)=>{let{ticker:r,qty:a,price:n,type:o,date:s}=t;if(e[r]||(e[r]={ticker:r,shares:0,avgCost:0,currency:t.currency||"USD",totalTrades:0,lastTradeDate:s,isMock:!1}),"BUY"===o){let t=e[r].shares*e[r].avgCost+a*n;e[r].shares+=a,e[r].avgCost=t/e[r].shares}else e[r].shares-=a;return e[r].totalTrades+=1,e[r].lastTradeDate=s,e},{}),s=Object.values(o).reduce((e,t)=>e+t.avgCost*t.shares,0),i=e.length,l=Object.keys(o).length;return{realTrades:e,mockTrades:t,validTrades:a,userTickers:n,positions:o,totalInvested:s,totalTrades:i,totalPositions:l}},[r]);return{trades:r,loading:s,error:c,userTickers:b,totalInvested:v,totalTrades:k,totalPositions:j,addTrade:u,deleteTrade:g,updateTrade:x,importTrades:h,migrateTrades:f,deleteAllTrades:(0,a.useCallback)(async()=>{if(!e)throw Error("User not authenticated");try{let t=await i.deleteAllTrades(e.uid);return o([]),t}catch(e){throw d(e instanceof Error?e.message:"Failed to delete all trades"),e}},[e]),cleanupOrphanedTrades:(0,a.useCallback)(async()=>{if(!e)throw Error("User not authenticated");try{let t=await i.cleanupOrphanedTrades(e.uid);return await p(),t}catch(e){throw d(e instanceof Error?e.message:"Failed to cleanup orphaned trades"),e}},[e,p]),refreshTrades:p}}}};