<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pocket Portfolio — Waitlist Admin</title>
  <link rel="icon" href="/icon-192.png" />
  <style>
    body { font: 14px/1.4 system-ui, sans-serif; background:#0b1220; color:#fff; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 0 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,.08); }
    th { text-align: left; color: #9fb0cc; font-weight: 600; }
    button { background:#2563eb; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .muted{ color:#9fb0cc; }
    .row{ display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    .pill{ padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Waitlist Admin</h1>
    <div class="row">
      <div id="me" class="pill muted">Not signed in</div>
      <button id="signin">Sign in with Google</button>
      <button id="signout" style="display:none;background:#334155">Sign out</button>
      <button id="export" style="display:none">Download CSV</button>
    </div>

    <p class="muted">Admins only. Data is read directly from <code>/waitlist</code> with Firestore rules.</p>

    <table id="t" style="margin-top:16px; display:none;">
      <thead><tr>
        <th>Email</th><th>Source</th><th>Page</th><th>User Agent</th><th>Created</th>
      </tr></thead>
      <tbody></tbody>
    </table>

    <p id="empty" class="muted" style="margin-top:16px; display:none;">No signups yet.</p>
  </div>

  <!-- Firebase compat (same as the app) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // --- config ---
    const ALLOWED_EMAILS = ["abbalawal22s@gmail.com","losthoodz22s@gmail.com"]; // <-- change
    const firebaseConfig = {
      apiKey: "AIzaSyDIL02q3thafHYAEziJVRlr4ibst5dqvRo",
      authDomain: "pocket-portfolio-67fa6.firebaseapp.com",
      projectId: "pocket-portfolio-67fa6",
    };

    // --- init ---
    if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $ = (s)=>document.querySelector(s);
    const me = $("#me"), signInBtn=$("#signin"), signOutBtn=$("#signout"),
          table=$("#t"), tbody=$("#t tbody"), empty=$("#empty"), exportBtn=$("#export");

    let unsub = null;
    let currentRows = [];

    function toCSV(rows){
      const esc = (s)=>`"${String(s??'').replace(/"/g,'""')}"`;
      const header = ["email","source","page","ua","createdAt"];
      const lines = [header.join(",")].concat(
        rows.map(r => header.map(h => esc(r[h])).join(","))
      );
      return lines.join("\r\n");
    }

    function download(filename, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/csv'}));
      a.download = filename;
      a.click();
    }

    function render(rows){
      currentRows = rows;
      tbody.innerHTML = "";
      if (!rows.length) {
        table.style.display = "none";
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";
      table.style.display = "table";

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.email || ""}</td>
          <td>${r.source || ""}</td>
          <td>${r.page || ""}</td>
          <td title="${r.ua || ""}">${(r.ua || "").slice(0,40)}${(r.ua||"").length>40?"…":""}</td>
          <td>${r.createdAt || ""}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function startStream(){
      if (unsub) unsub();
      unsub = db.collection("waitlist")
        .orderBy("createdAt","desc")
        .limit(1000)
        .onSnapshot(snap => {
          const rows = snap.docs.map(d => {
            const x = d.data() || {};
            return {
              email: x.email,
              source: x.source,
              page: x.page,
              ua: x.ua,
              createdAt: x.createdAt?.toDate?.().toISOString?.() || ""
            };
          });
          render(rows);
        }, err => {
          console.error("admin stream error", err);
          alert("Read denied. Make sure your Firestore rules allow admin read.");
        });
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        me.textContent = user.email || "Signed in";
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";

        // gate by email (server rules also enforce)
        if (!ALLOWED_EMAILS.includes((user.email||"").toLowerCase())) {
          alert("This account is not an admin.");
          auth.signOut();
          return;
        }
        exportBtn.style.display = "inline-block";
        startStream();
      } else {
        me.textContent = "Not signed in";
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        exportBtn.style.display = "none";
        if (unsub) unsub();
        render([]);
      }
    });

    signInBtn.onclick = async () => {
      try {
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      } catch {
        await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
      }
    };
    signOutBtn.onclick = () => auth.signOut();
    exportBtn.onclick = () => download(`waitlist-${new Date().toISOString().slice(0,10)}.csv`, toCSV(currentRows));
  </script>
</body>
</html>
