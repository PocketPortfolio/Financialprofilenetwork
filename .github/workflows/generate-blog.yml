name: Generate Blog Posts

on:
  schedule:
    # Run every 2 hours for maximum reliability (12 checks per day)
    # Posts are generated when their date <= today and status is "pending"
    - cron: '0 */2 * * *'  # Every 2 hours: 00:00, 02:00, 04:00, 06:00, 08:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00 UTC
    # Also run at 9 AM UTC as primary time (keeps original schedule)
    - cron: '0 9 * * *'
    # One-time: Real-Time Portfolio Tracking post at 16:00 GMT on Jan 5, 2026
    - cron: '0 16 5 1 *'  # 16:00 UTC on Jan 5, 2026
    # One-time: NYE 2025 Year in Review post at 18:30 GMT (Dec 31, 2025)
    - cron: '30 18 31 12 *'
  workflow_dispatch: # Allow manual triggering (for testing/debugging only)

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify OpenAI API Key
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ ERROR: OPENAI_API_KEY secret is not set"
            exit 1
          fi
          echo "âœ… OPENAI_API_KEY is configured"

      - name: Generate blog posts (with automatic retry)
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          MAX_RETRIES=3
          RETRY_COUNT=0
          EXIT_CODE=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ðŸš€ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            if npm run generate-blog; then
              echo "âœ… Blog generation completed successfully"
              echo "error=false" >> $GITHUB_OUTPUT
              EXIT_CODE=0
              break
            else
              EXIT_CODE=$?
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Attempt $RETRY_COUNT failed, waiting 5 minutes before retry..."
                sleep 300
              else
                echo "âŒ Blog generation failed after $MAX_RETRIES attempts"
                echo "error=true" >> $GITHUB_OUTPUT
              fi
            fi
          done
          
          if [ $EXIT_CODE -ne 0 ]; then
            exit $EXIT_CODE
          fi

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected - will commit and push"
            git status --short
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes to commit"
          fi

      - name: Stage generated files
        if: steps.changes.outputs.changes == 'true'
        run: |
          echo "ðŸ“¦ Staging generated files..."
          # Use find to expand glob patterns properly
          find content/posts -name "*.mdx" -type f -exec git add {} + || true
          find public/images/blog -name "*.png" -type f -exec git add {} + || true
          git add content/blog-calendar.json || true
          echo "âœ… Files staged:"
          git status --short

      - name: Commit and push changes
        if: steps.changes.outputs.changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ðŸ¤– Auto-generate blog posts'
          commit_user_name: 'Pocket Portfolio Bot'
          commit_user_email: 'bot@pocketportfolio.app'
          commit_options: '--no-verify'
          skip_dirty_check: true
          # Don't use file_pattern - files are already staged above

      - name: Check for overdue posts
        if: failure()
        id: overdue-check
        run: |
          node -e "
          const fs = require('fs');
          const calendar = JSON.parse(fs.readFileSync('content/blog-calendar.json', 'utf-8'));
          const today = new Date().toISOString().split('T')[0];
          const overdue = calendar.filter(p => p.date < today && p.status === 'pending');
          
          if (overdue.length > 0) {
            console.log('OVERDUE_COUNT=' + overdue.length);
            console.log('OVERDUE_POSTS=' + JSON.stringify(overdue.map(p => ({title: p.title, date: p.date}))));
            process.exit(0);
          } else {
            console.log('OVERDUE_COUNT=0');
            process.exit(0);
          }
          " >> $GITHUB_ENV
          echo "overdue_count=${{ env.OVERDUE_COUNT }}" >> $GITHUB_OUTPUT
          echo "overdue_posts=${{ env.OVERDUE_POSTS }}" >> $GITHUB_OUTPUT

      - name: Create GitHub issue for overdue posts
        if: failure() && steps.overdue-check.outputs.overdue_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const overdue = JSON.parse('${{ steps.overdue-check.outputs.overdue_posts }}');
            const overdueList = overdue.map(p => `- **${p.title}** (scheduled: ${p.date})`).join('\n');
            
            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'blog-overdue'
            });
            
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Blog Generation Failed: ${overdue.length} Post(s) Overdue`,
                body: `## âš ï¸ Overdue Blog Posts\n\n${overdueList}\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n**Action Required:**\n1. Check workflow logs for errors\n2. Verify OPENAI_API_KEY secret is set\n3. Manually trigger workflow if needed\n4. Close this issue once posts are generated`,
                labels: ['bug', 'urgent', 'blog-overdue']
              });
              console.log('ðŸš¨ Created GitHub issue for overdue posts');
            } else {
              console.log('â„¹ï¸ Issue already exists for overdue posts');
            }

      - name: Workflow Summary
        if: always()
        run: |
          echo "## ðŸ“Š Blog Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
            echo "âœ… **Changes committed and pushed**" >> $GITHUB_STEP_SUMMARY
            echo "- New blog posts have been generated" >> $GITHUB_STEP_SUMMARY
            echo "- Changes have been pushed to main branch" >> $GITHUB_STEP_SUMMARY
            echo "- Deployment will trigger automatically" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "- No posts were due for generation" >> $GITHUB_STEP_SUMMARY
            echo "- Or all posts were already generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.generate.outputs.error }}" == "true" ]; then
            echo "âš ï¸ **Some posts may have failed** - Check logs above for details" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.overdue-check.outputs.overdue_count }}" != "0" ]; then
              echo "ðŸš¨ **${{ steps.overdue-check.outputs.overdue_count }} overdue post(s) detected** - GitHub issue created" >> $GITHUB_STEP_SUMMARY
            fi
          fi


