name: Generate Blog Posts

on:
  schedule:
    # Daily at 9 AM UTC - checks for due posts automatically
    # Posts are generated when their date <= today and status is "pending"
    - cron: '0 9 * * *'
    # One-time: NYE 2025 Year in Review post at 17:30 GMT (Dec 31, 2025)
    - cron: '30 17 31 12 *'
  workflow_dispatch: # Allow manual triggering (for testing/debugging only)

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify OpenAI API Key
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ ERROR: OPENAI_API_KEY secret is not set"
            exit 1
          fi
          echo "âœ… OPENAI_API_KEY is configured"

      - name: Generate blog posts
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ðŸš€ Starting blog post generation..."
          npm run generate-blog || exit_code=$?
          if [ -n "$exit_code" ]; then
            echo "âš ï¸ Blog generation completed with errors (exit code: $exit_code)"
            echo "error=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Blog generation completed successfully"
            echo "error=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected - will commit and push"
            git status --short
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes to commit"
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ðŸ¤– Auto-generate blog posts [skip ci]'
          commit_user_name: 'Pocket Portfolio Bot'
          commit_user_email: 'bot@pocketportfolio.app'
          commit_options: '--no-verify'
          skip_dirty_check: false
          file_pattern: |
            content/posts/**/*.mdx
            public/images/blog/**/*.png
            content/blog-calendar.json

      - name: Workflow Summary
        if: always()
        run: |
          echo "## ðŸ“Š Blog Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
            echo "âœ… **Changes committed and pushed**" >> $GITHUB_STEP_SUMMARY
            echo "- New blog posts have been generated" >> $GITHUB_STEP_SUMMARY
            echo "- Changes have been pushed to main branch" >> $GITHUB_STEP_SUMMARY
            echo "- Deployment will trigger automatically" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "- No posts were due for generation" >> $GITHUB_STEP_SUMMARY
            echo "- Or all posts were already generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.generate.outputs.error }}" == "true" ]; then
            echo "âš ï¸ **Some posts may have failed** - Check logs above for details" >> $GITHUB_STEP_SUMMARY
          fi


