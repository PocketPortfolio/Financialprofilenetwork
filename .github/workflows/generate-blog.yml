name: Generate Blog Posts

on:
  schedule:
    # SELF-HEALING: Run every hour to catch missed posts (GitHub Actions cron is unreliable)
    # This ensures posts are generated even if scheduled runs fail
    - cron: '0 * * * *'  # Every hour at :00 minutes - Self-healing check for missed posts
    # Run every 2 hours for maximum reliability (12 checks per day)
    # Posts are generated when their date <= today and status is "pending"
    - cron: '0 */2 * * *'  # Every 2 hours: 00:00, 02:00, 04:00, 06:00, 08:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00 UTC
    # Also run at 9 AM UTC as primary time (keeps original schedule)
    - cron: '0 9 * * *'
    # One-time: Real-Time Portfolio Tracking post at 16:00 GMT on Jan 5, 2026
    - cron: '0 16 5 1 *'  # 16:00 UTC on Jan 5, 2026
    # One-time: NYE 2025 Year in Review post at 18:30 GMT (Dec 31, 2025)
    - cron: '30 18 31 12 *'
    # One-time: Building Production-Ready Systems post at 10:00 UTC on Jan 6, 2026 (TEST - verify fixes)
    - cron: '0 10 6 1 *'  # 10:00 UTC on Jan 6, 2026 - Test autonomous engine with fixes
    # One-time: AI-Powered Financial Analysis post at 12:30 UTC on Jan 6, 2026 (STRESS TEST - verify cron reliability)
    - cron: '30 12 6 1 *'  # 12:30 UTC on Jan 6, 2026 - Stress test AI post (rescheduled from 12:00 to test system)
  workflow_dispatch: # Allow manual triggering (for testing/debugging only)

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify OpenAI API Key
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ ERROR: OPENAI_API_KEY secret is not set"
            exit 1
          fi
          echo "âœ… OPENAI_API_KEY is configured"

      - name: Generate blog posts (with automatic retry)
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ðŸ• Workflow started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“… Checking for posts due today..."
          echo ""
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          EXIT_CODE=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ðŸš€ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            if npm run generate-blog 2>&1 | tee /tmp/generate-output.log; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… Blog generation completed successfully"
              echo "error=false" >> $GITHUB_OUTPUT
              EXIT_CODE=0
              break
            else
              EXIT_CODE=$?
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Attempt $RETRY_COUNT failed, waiting 5 minutes before retry..."
                echo "Last error output:"
                tail -20 /tmp/generate-output.log || echo "No output log available"
                sleep 300
              else
                echo "âŒ Blog generation failed after $MAX_RETRIES attempts"
                echo "Final error output:"
                tail -50 /tmp/generate-output.log || echo "No output log available"
                echo "error=true" >> $GITHUB_OUTPUT
              fi
            fi
          done
          
          if [ $EXIT_CODE -ne 0 ]; then
            exit $EXIT_CODE
          fi

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected - will commit and push"
            git status --short
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes to commit"
          fi

      - name: Stage generated files
        if: steps.changes.outputs.changes == 'true'
        run: |
          echo "ðŸ“¦ Staging generated files..."
          # Force add files to ensure they're staged even if git thinks they're unchanged
          find content/posts -name "*.mdx" -type f -exec git add -f {} + || true
          find public/images/blog -name "*.png" -type f -exec git add -f {} + || true
          git add -f content/blog-calendar.json || true
          git add -f content/how-to-tech-calendar.json || true
          echo "âœ… Files staged:"
          git status --short
          
          # Verify files are actually in the index
          if [ -n "$(git diff --cached --name-only)" ]; then
            echo "âœ… Changes confirmed in index - will commit"
          else
            echo "âš ï¸ No changes in index - checking if files exist..."
            # List files that should exist
            find content/posts -name "*.mdx" -type f | head -5
            find public/images/blog -name "*.png" -type f | head -5
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ðŸ¤– Auto-generate blog posts'
          commit_user_name: 'Pocket Portfolio Bot'
          commit_user_email: 'bot@pocketportfolio.app'
          commit_options: '--no-verify'
          skip_dirty_check: true
          # Don't use file_pattern - files are already staged above

      - name: Verify Vercel Secrets
        if: steps.changes.outputs.changes == 'true'
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âŒ ERROR: VERCEL_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "âŒ ERROR: VERCEL_ORG_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "âŒ ERROR: VERCEL_PROJECT_ID secret is not set"
            exit 1
          fi
          echo "âœ… All Vercel secrets are configured"

      - name: Deploy to Vercel Production
        if: steps.changes.outputs.changes == 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      - name: Check for overdue posts
        if: failure()
        id: overdue-check
        run: |
          node -e "
          const fs = require('fs');
          const calendar = JSON.parse(fs.readFileSync('content/blog-calendar.json', 'utf-8'));
          const today = new Date().toISOString().split('T')[0];
          const overdue = calendar.filter(p => p.date < today && p.status === 'pending');
          
          if (overdue.length > 0) {
            console.log('OVERDUE_COUNT=' + overdue.length);
            console.log('OVERDUE_POSTS=' + JSON.stringify(overdue.map(p => ({title: p.title, date: p.date}))));
            process.exit(0);
          } else {
            console.log('OVERDUE_COUNT=0');
            process.exit(0);
          }
          " >> $GITHUB_ENV
          echo "overdue_count=${{ env.OVERDUE_COUNT }}" >> $GITHUB_OUTPUT
          echo "overdue_posts=${{ env.OVERDUE_POSTS }}" >> $GITHUB_OUTPUT

      - name: Create GitHub issue for overdue posts
        if: failure() && steps.overdue-check.outputs.overdue_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const overdue = JSON.parse('${{ steps.overdue-check.outputs.overdue_posts }}');
            const overdueList = overdue.map(p => `- **${p.title}** (scheduled: ${p.date})`).join('\n');
            
            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'blog-overdue'
            });
            
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Blog Generation Failed: ${overdue.length} Post(s) Overdue`,
                body: `## âš ï¸ Overdue Blog Posts\n\n${overdueList}\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n**Action Required:**\n1. Check workflow logs for errors\n2. Verify OPENAI_API_KEY secret is set\n3. Manually trigger workflow if needed\n4. Close this issue once posts are generated`,
                labels: ['bug', 'urgent', 'blog-overdue']
              });
              console.log('ðŸš¨ Created GitHub issue for overdue posts');
            } else {
              console.log('â„¹ï¸ Issue already exists for overdue posts');
            }

      - name: Check for expected posts
        if: always()
        id: expected-posts
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const calendar = JSON.parse(fs.readFileSync('content/blog-calendar.json', 'utf-8'));
          const today = new Date().toISOString().split('T')[0];
          const expectedPosts = calendar.filter(p => p.date === today && p.status === 'pending');
          
          if (expectedPosts.length > 0) {
            console.log('EXPECTED_POSTS=' + expectedPosts.length);
            console.log('EXPECTED_POSTS_LIST=' + JSON.stringify(expectedPosts.map(p => ({id: p.id, title: p.title, date: p.date, slug: p.slug}))));
            process.exit(0);
          } else {
            console.log('EXPECTED_POSTS=0');
            process.exit(0);
          }
          " >> $GITHUB_ENV
          echo "expected_posts=${{ env.EXPECTED_POSTS }}" >> $GITHUB_OUTPUT
          echo "expected_posts_list=${{ env.EXPECTED_POSTS_LIST }}" >> $GITHUB_OUTPUT

      - name: Verify expected posts were generated
        if: always() && steps.expected-posts.outputs.expected_posts > 0
        id: verify-posts
        continue-on-error: false
        run: |
          echo "ðŸ” Verifying expected posts were actually generated..."
          node -e "
          const fs = require('fs');
          const path = require('path');
          const expectedPosts = JSON.parse('${{ steps.expected-posts.outputs.expected_posts_list }}');
          const missingPosts = [];
          
          console.log('Checking ' + expectedPosts.length + ' expected post(s)...');
          
          for (const post of expectedPosts) {
            const mdxPath = path.join('content', 'posts', post.slug + '.mdx');
            const imagePath = path.join('public', 'images', 'blog', post.slug + '.png');
            
            const mdxExists = fs.existsSync(mdxPath);
            const imageExists = fs.existsSync(imagePath);
            
            if (!mdxExists || !imageExists) {
              missingPosts.push({
                id: post.id,
                title: post.title,
                slug: post.slug,
                mdxExists: mdxExists,
                imageExists: imageExists
              });
              console.error('âŒ Missing: ' + post.title);
              console.error('   MDX: ' + (mdxExists ? 'âœ…' : 'âŒ') + ' ' + mdxPath);
              console.error('   Image: ' + (imageExists ? 'âœ…' : 'âŒ') + ' ' + imagePath);
            } else {
              console.log('âœ… Found: ' + post.title);
            }
          }
          
          if (missingPosts.length > 0) {
            console.error('âŒ CRITICAL: ' + missingPosts.length + ' expected post(s) were NOT generated!');
            console.log('MISSING_POSTS=' + missingPosts.length);
            console.log('MISSING_POSTS_LIST=' + JSON.stringify(missingPosts));
            process.exit(1);
          } else {
            console.log('âœ… All expected posts verified successfully');
            console.log('MISSING_POSTS=0');
            process.exit(0);
          }
          "
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ CRITICAL FAILURE: Expected posts were not generated!"
            echo "The workflow will fail to alert you immediately."
            exit 1
          fi

      - name: Create issue if expected posts not generated
        if: always() && steps.expected-posts.outputs.expected_posts > 0 && (steps.verify-posts.outcome == 'failure' || steps.changes.outputs.changes != 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const expectedPosts = JSON.parse('${{ steps.expected-posts.outputs.expected_posts_list }}');
            const postList = expectedPosts.map(p => `- **${p.title}** (ID: ${p.id}, Date: ${p.date})`).join('\n');
            
            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'blog-expected-not-generated',
              since: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
            });
            
            const today = new Date().toISOString().split('T')[0];
            const todayIssues = issues.filter(i => i.title.includes(today));
            
            if (todayIssues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Expected Posts Not Generated: ${expectedPosts.length} post(s) for ${today}`,
                body: `## âš ï¸ Expected Posts Not Generated\n\n**Date**: ${today}\n**Expected Posts**: ${expectedPosts.length}\n\n### Posts That Should Have Been Generated:\n\n${postList}\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n**Possible Causes:**\n1. Workflow ran but script didn't detect posts (check logs)\n2. Workflow ran but generation failed silently\n3. Workflow didn't run at all (check schedule)\n\n**Action Required:**\n1. Check workflow logs for errors\n2. Verify post dates in calendar match today\n3. Manually trigger workflow if needed\n4. Close this issue once posts are generated`,
                labels: ['bug', 'urgent', 'blog-expected-not-generated']
              });
              console.log('ðŸš¨ Created GitHub issue for expected posts not generated');
            } else {
              console.log('â„¹ï¸ Issue already exists for today');
            }

      - name: Workflow Summary
        if: always()
        run: |
          echo "## ðŸ“Š Blog Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
            echo "âœ… **Changes committed and pushed**" >> $GITHUB_STEP_SUMMARY
            echo "- New blog posts have been generated" >> $GITHUB_STEP_SUMMARY
            echo "- Changes have been pushed to main branch" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Deployed to Vercel Production** (autonomous deployment)" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.expected-posts.outputs.expected_posts }}" != "0" ]; then
              if [ "${{ steps.verify-posts.outcome }}" == "success" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âœ… **All expected posts verified** - Files exist and are correct" >> $GITHUB_STEP_SUMMARY
              elif [ "${{ steps.verify-posts.outcome }}" == "failure" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âŒ **CRITICAL: Expected posts were NOT generated despite changes!**" >> $GITHUB_STEP_SUMMARY
                echo "- Some files may be missing" >> $GITHUB_STEP_SUMMARY
                echo "- GitHub issue created automatically" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.expected-posts.outputs.expected_posts }}" != "0" ]; then
              echo "âš ï¸ **WARNING: Expected ${{ steps.expected-posts.outputs.expected_posts }} post(s) for today but none were generated!**" >> $GITHUB_STEP_SUMMARY
              echo "- Check logs above for errors" >> $GITHUB_STEP_SUMMARY
              echo "- GitHub issue created automatically" >> $GITHUB_STEP_SUMMARY
            else
              echo "- No posts were due for generation today" >> $GITHUB_STEP_SUMMARY
              echo "- Or all posts were already generated" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.generate.outputs.error }}" == "true" ]; then
            echo "âš ï¸ **Some posts may have failed** - Check logs above for details" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.overdue-check.outputs.overdue_count }}" != "0" ]; then
              echo "ðŸš¨ **${{ steps.overdue-check.outputs.overdue_count }} overdue post(s) detected** - GitHub issue created" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Scheduled Run:** Check workflow schedule for next execution time" >> $GITHUB_STEP_SUMMARY


